<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>（重新）体验了一下 GuixSD 和 NixOS - Untitled</title>
    <meta name="description" content="很久之前就听说 FSF 的老贼们整了一个新包管理和发行版叫 guix 和 GuixSD，当时看介绍说 guix 是个 “Transactional Package Manager”，之后没有仔细去了解过。前两天突然看到有人发了个文章安利 GuixSD，看了一下发现这玩意儿怎么跟之前体验过一下的 NixOS 那么像...">
    <link href="//fonts.googleapis.com/css?family=Inconsolata:400,700&amp;subset=latin-ext,vietnamese"rel="stylesheet">
    <link rel="stylesheet" href="/css/main.css">
    <link rel="canonical" href="https://v2bv.net/2019/guixsd-and-nixos">
    <link rel="alternate" type="application/rss+xml" title="Untitled" href="https://v2bv.net/feed.xml">
    <link rel="manifest" href="/manifest.json">
    <script>
      if('serviceWorker' in navigator) {
        navigator.serviceWorker
          .register('/service-worker.js')
          .then(function() { console.log("Service Worker Registered"); });
      }
    </script>
    <link rel="amphtml" href="https://v2bv.net/amp/2019/guixsd-and-nixos">
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-97897080-1', 'auto');
      ga('send', 'pageview');
    </script>
    <script type="application/ld+json">
      {
          "@context": "https://schema.org",
          "@type": "Article",
          "publisher": {
              "@type": "Organization",
              "name": "Sth.",
              "logo": "/favicon.ico"
          },
          "author": {
              "@type": "Person",
              "name": "Kay",
              "image": {
                  "@type": "ImageObject",
                  "url": "/avatar.jpg",
              },
              "description": "Untitled"
          },
          "headline": "（重新）体验了一下 GuixSD 和 NixOS",
          "url": "https://v2bv.net",
          "datePublished": "Jan 23, 2019",
          "mainEntityOfPage": {
              "@type": "WebPage",
              "@id": "https://v2bv.net"
          }
      }
    </script>
  </head>
  <body>
    <div class="u-container">
      <div class="c-page">
        <article class="c-article">
          <header class="c-page__header" id="page_header">
            <h1 itemprop="articleSection">Untitled</h1>
            <p>
              <a href="/">&lt;&ndash;&ndash; Back</a>
            </p>
          </header>
          <div class="c-article__main">
            <article class="c-article">
              <header class="c-article__header">
                <div id="article_title">
                  <h1 class="c-article__title">（重新）体验了一下 GuixSD 和 NixOS</h1>
                </div>
                <div id="article_time">
                  <p class="c-article__time">
                    <time content="2019-01-23">
                      Jan 23, 2019
                    </time>
                  </p>
                </div>
              </header>
              <div class="c-article__main">
                <p>很久之前就听说 FSF 的老贼们整了一个新包管理和发行版叫 guix 和 GuixSD，当时看介绍说 guix 是个 “Transactional Package Manager”，之后没有仔细去了解过。前两天突然看到有人发了个文章安利 GuixSD，看了一下发现这玩意儿怎么跟之前体验过一下的 NixOS 那么像？查了一下才知道这好像就是个 nix （NixOS 的包管理）的 fork 来着。感觉 FSF 的老贼们真的是什么发行版火了就照着做一个全自由软件的 GNU/Linux-libre 发行版。不过这次 guix 相比 nix 还是有不少改动的（不像别的就只是重新打了个包），配置文件使用的语言从 nix 自创的 nix 换成了 Guile Scheme，init 系统从 systemd 换成了 Shepherd（我前几天才听说有这么个东西，本来是给 Hurd 用的） ，成功地让我起了兴趣（虽然我的兴趣不值钱）。</p>
                <p>安装过程什么的我就不多说了，两边都有文档，个人感觉 NixOS 的文档更详细一点但是也更乱。后面会带上我用的配置。</p>
                <p>这两个发行版做的就是让一个包管理根据一套配置管理整个系统（包括软件本身和各种配置）；同时把所有软件都放到一个目录下集中管理（guix 下是 /gnu，NixOS 下是 /nix），然后在根据一定设置创建 symlink 到另一个目录下模拟出一个环境叫 profile 使用。优点是你想让多少个不同版本的同一个软件共存就能放几个，还有回滚系统等等的能力。大概可以理解为做一个高级版的 snapd 或 flatpak 或 docker，然后用它来管理整个系统。具体可以去看他们的介绍，比如 <a href="https://nixos.org/nixos/nix-pills/">Nix Pills</a>，我语文不好就不多说了。</p>
                <p>反正体验就是，装完了之后，什么 /nix 或 /gnu 之外，几乎什么都没有，/run 下面成吨成吨的 symlink。</p>
                <p>（哦对了，guix 和 nix 都可以在别的发行版上运行，nix 甚至能用来拯救 macOS，不一定要装他们的发行版也能体验到一部分功能。）</p>
                <p>听起来很美好，但是这跟现有 Linux 发行版区别还是很大，两个发行版本身人手也不算多，就导致会有一些问题，就比如：</p>
                <p>共同的坑：</p>
                <ul>
                  <li><strong>完全</strong>不遵守 LSB，别人发行的二进制除非 patchelf 不然都不能运行。</li>
                  <li>总体来说资料还是少，虽然 NixOS 已经是一个从 2003 年开始就有的老项目了，文档还是不算多；至于 guix… 包管理相关的东西倒是都有文档，但是缺乏新手指引和示例导致很多部分很难看懂（比如设置默认 shell 的语法，文档里说是用一个 G-Expression，但是并没有写明具体的使用方法，G-Expression 的文档页面也没说使用方法），部分常见问题倒是能在邮件列表里找到，总体来说还是少。</li>
                  <li>可能是因为对软件的魔改还不够彻底，有的时候还是会遇到点小问题。</li>
                  <li>可能因为中文用户较少，这两个发行版的默认中文字体渲染都很烂。</li>
                </ul>
                <p>GuixSD：</p>
                <p><strong>（GuixSD 还是新发行版，以后可能还会有改动，下面所有的都是基于 0.16 版来说）</strong></p>
                <ul>
                  <li>它是一个 GNU/Linux-libre 的全自由软件的发行版，这意味着它在非常清蒸的同时也丢掉了对很多硬件/程序的支持（除非自行打包内核和那些对应的软件）。只是我手头正好有一台换了 ath9k 网卡的 ThinkPad X220 才可以无痛使用，不然无线网卡驱动、显卡驱动等等可能都会有问题。同时那群维护者在自由软件上也是激进过头了，<a href="https://gnunet.org/bot/log/guix/2016-05-16">之前</a>有人在 IRC 上问能不能打包 Telegram Desktop（GPLv3），可能是维护者的几个人在讨论之后说“这 IM 服务端不自由还是用 IRC 或电邮吧”就不了了之了，到现在都没打包。</li>
                  <li>我照着官方文档配了 LUKS 结果不能启动，最后还是用了普通 ext4。说起来挺搞笑的… 它把内核什么的全放在 LUKS 加密过的分区里，GRUB 上也不做别的配置，能启动才怪了…</li>
                  <li>有部分包上游没有进行构建，这时候 guix 会自动下载工具链进行编译安装（比如 IceCat，自由版本的 Firefox，我 X220 上编译花了几个小时），这就意味着在老机器上安装包可能会比较痛苦。</li>
                  <li>还是之前说的文档问题，我花了挺多时间都没找到让它根据 file system label 来启用 SWAP 分区的方法，而这样的问题还有不少。</li>
                  <li>工具链版本有点奇妙，我看它安装的时候 GCC 5 6 7 8 都下载了一遍，直接安装 GCC 竟然装的是 GCC 5.5.0，9102 年了还 5.5.0… 太丢人了（还亏它是 FSF 亲儿子呢）。</li>
                  <li>IME 支持很烂，fcitx 只打了 fcitx 本体和 fcitx-configtool；RIME 之类的输入法引擎全归类到 iBus 模块下面了，我在 IRC 频道里问了相关事情就直接被忽略了；iBus 装上之后除 GNOME 外都没办法让它自动启动，传统发行版上 .xprofile 里加变量的方式完全没用，文档里也没有提到任何相关的东西；<del>RIME 可能是坏的，无法启动。</del><br />
                    后来有个大佬在 Telegram 里联系了我，说 RIME 实际是可以用的，但是需要<a href="https://github.com/guix-china/help">额外的设置</a>，还是没有 NixOS 用的方法完善。可能需要有知道怎么做才好的人去把它做成一个 module（就像 NixOS 那样）。但我应该不会是那个人，原因见下。</li>
                  <li>MATE 下的锁屏是坏的（什么都不做就说 Authentication Failed），xfce 下无法启动输入法，就只有 GNOME 可能还能用。</li>
                  <li>fontconfig 只会读用户 profile 下的字体。</li>
                  <li>Shepherd 还是太冷门惹… 启动速度也比 systemd 慢<del>（不过至少比 BSD init 快）</del>。</li>
                </ul>
                <p>我没去报 bug 的原因是：一，我懒，我去问问题都没人理我，我干嘛要帮他们（虽然我也帮不大上）；二，他们的 Bug tracker 太硬核叻… 只有邮件列表，Bug report 和提交 patch 都在一起的，我不敢说话 🤦‍♀️</p>
                <p>NixOS：</p>
                <ul>
                  <li>默认的包有点老了… 内核默认还在用 4.14… Stable 最新 4.19， Unstable 已经打了 4.20，需要手动指定才能用新的。</li>
                  <li>听说 Nixpkgs Unstable 的包数量都快超过 AUR 了（老早超过 Debiantai 了），但是实际用的时候还是比 AUR 少了一些东西。</li>
                  <li>IME 基本能用，但是我实在不知道打了 fcitx-rime 不打 ibus-rime 是什么操作… 要不过两天我打个试试？</li>
                  <li>因为是自动检查更新并打包的，所以有时候会打了 Unstable 的软件，比如说这次 MATE 就打了个 1.21… 然后一些主题炸了。我找到了一个相关的降级回 1.20 的 PR，我稍微催了一下马上就给合并了，并且禁止了 bot 自动查找 MATE 的新版本（可能他们的 bot 还不支持根据一定规则跳过部分版本？），给我感觉还是挺好的 XD</li>
                </ul>
                <p>总的来说感觉 NixOS 的可用性比 GuixSD 高出一大截。另外虽然我想说我更喜欢 Scheme 而不是这个 nix… 但是感觉有的时候还是 nix 的可读性更好一点。</p>
                <p>其实我感觉他们既然都已经有那么多吨 symlink 了，为什么不干脆遵守一下 LSB 呢，无非就是再多几吨 symlink… 这样碎片化越来越严重对整个社区都没什么好处啊。<br />
                  多版本共存？实际使用场景并不多。其实这方面感觉真的很像 flatpak 或 snap…<br />
                  Reproducible build？ 这应该是大多数发行版的打包系统的标配吧，只是他们把这暴露给了普通用户。<br />
                  至于资料的话它们毕竟还算是比较冷门的… 还算能原谅。</p>
                <p>至于说这是 Linux 发行版的未来吗？我不知道啊。这确实看上去很有趣，但是实际使用上并没有那么美好，同时感觉也缺少能竞争过传统发行版的地方。</p>
                <hr />
                <p>我 GuixSD 的配置其实跟官方示例比没多大变化… 因为不知道怎么改：</p>
                <div class="language-scheme highlighter-rouge">
                  <div class="highlight">
                    <pre class="highlight"><code><span class="c1">;; This is an operating system configuration template</span>
<span class="c1">;; for a "desktop" setup with GNOME and Xfce where the</span>
<span class="c1">;; root partition is encrypted with LUKS.</span>

<span class="p">(</span><span class="nf">use-modules</span> <span class="p">(</span><span class="nf">gnu</span><span class="p">)</span> <span class="p">(</span><span class="nf">gnu</span> <span class="nv">system</span> <span class="nv">nss</span><span class="p">))</span>
<span class="p">(</span><span class="nf">use-service-modules</span> <span class="nv">desktop</span> <span class="nv">ssh</span><span class="p">)</span>
<span class="p">(</span><span class="nf">use-package-modules</span> <span class="nv">certs</span> 
                     <span class="nv">xorg</span> <span class="nv">mate</span> <span class="nv">fonts</span> <span class="nv">fontutils</span> <span class="nv">gnome</span> <span class="nv">freedesktop</span> <span class="nv">xdisorg</span>
                     <span class="nv">ssh</span> <span class="nv">shells</span> <span class="nv">ncurses</span> <span class="nv">file</span>
                     <span class="nv">gnuzilla</span> <span class="nv">curl</span> <span class="nv">wget</span> <span class="nv">rsync</span>
                     <span class="nv">gcc</span> <span class="nv">ibus</span>
                     <span class="nv">version-control</span><span class="p">)</span>

<span class="p">(</span><span class="nf">operating-system</span>
  <span class="p">(</span><span class="nf">host-name</span> <span class="s">"x220"</span><span class="p">)</span>
  <span class="p">(</span><span class="nf">timezone</span> <span class="s">"America/Los_Angeles"</span><span class="p">)</span>
  <span class="p">(</span><span class="nf">locale</span> <span class="s">"en_US.utf8"</span><span class="p">)</span>

  <span class="c1">;; Use the UEFI variant of GRUB with the EFI System</span>
  <span class="c1">;; Partition mounted on /boot/efi.</span>
  <span class="p">(</span><span class="nf">bootloader</span> <span class="p">(</span><span class="nf">bootloader-configuration</span>
                <span class="p">(</span><span class="nf">bootloader</span> <span class="nv">grub-efi-bootloader</span><span class="p">)</span>
                <span class="p">(</span><span class="nf">target</span> <span class="s">"/boot/efi"</span><span class="p">)))</span>

  <span class="p">(</span><span class="nf">kernel-arguments</span> <span class="o">'</span><span class="p">(</span><span class="s">"thinkpad_acpi.fan_control=1"</span><span class="p">))</span>

  <span class="c1">;; Specify a mapped device for the encrypted root partition.</span>
  <span class="c1">;; The UUID is that returned by 'cryptsetup luksUUID'.</span>
  <span class="c1">;;</span>
  <span class="c1">;; (mapped-devices</span>
  <span class="c1">;;  (list (mapped-device</span>
  <span class="c1">;;         (source (uuid "5786a4c6-9a95-4b4d-97e5-8ae7c5a99f44"))</span>
  <span class="c1">;;         (target "root")</span>
  <span class="c1">;;         (type luks-device-mapping))))</span>

  <span class="p">(</span><span class="nf">file-systems</span> <span class="p">(</span><span class="nf">cons*</span> <span class="p">(</span><span class="nf">file-system</span>
                         <span class="p">(</span><span class="nf">device</span> <span class="p">(</span><span class="nf">file-system-label</span> <span class="s">"GUIX"</span><span class="p">))</span>
                         <span class="p">(</span><span class="nf">mount-point</span> <span class="s">"/"</span><span class="p">)</span>
                         <span class="p">(</span><span class="nf">type</span> <span class="s">"ext4"</span><span class="p">))</span>
                         <span class="c1">;; (dependencies mapped-devices))</span>
                       <span class="p">(</span><span class="nf">file-system</span>
                         <span class="p">(</span><span class="nf">device</span> <span class="p">(</span><span class="nf">file-system-label</span> <span class="s">"EFI"</span><span class="p">))</span>
                         <span class="p">(</span><span class="nf">mount-point</span> <span class="s">"/boot/efi"</span><span class="p">)</span>
                         <span class="p">(</span><span class="nf">type</span> <span class="s">"vfat"</span><span class="p">))</span>
                       <span class="nv">%base-file-systems</span><span class="p">))</span>

  <span class="p">(</span><span class="nf">swap-devices</span> <span class="o">'</span><span class="p">(</span><span class="s">"/dev/sda3"</span><span class="p">))</span>

  <span class="p">(</span><span class="nf">users</span> <span class="p">(</span><span class="nb">cons</span> <span class="p">(</span><span class="nf">user-account</span>
                <span class="p">(</span><span class="nf">name</span> <span class="s">"kay"</span><span class="p">)</span>
                <span class="p">(</span><span class="nf">comment</span> <span class="s">"Kay"</span><span class="p">)</span>
                <span class="p">(</span><span class="nf">group</span> <span class="s">"users"</span><span class="p">)</span>
                <span class="p">(</span><span class="nf">supplementary-groups</span> <span class="o">'</span><span class="p">(</span><span class="s">"wheel"</span> <span class="s">"netdev"</span>
                                        <span class="s">"audio"</span> <span class="s">"video"</span><span class="p">))</span>
                <span class="p">(</span><span class="nf">home-directory</span> <span class="s">"/home/kay"</span><span class="p">)</span>
                <span class="p">(</span><span class="nf">shell</span> <span class="o">#</span><span class="nv">~</span><span class="p">(</span><span class="nb">string-append</span> <span class="o">#</span><span class="nv">$zsh</span> <span class="s">"/bin/zsh"</span><span class="p">)))</span>
               <span class="nv">%base-user-accounts</span><span class="p">))</span>

  <span class="c1">;; This is where we specify system-wide packages.</span>
  <span class="p">(</span><span class="nf">packages</span> <span class="p">(</span><span class="nf">cons*</span> <span class="nv">nss-certs</span>         <span class="c1">;for HTTPS access</span>
                   <span class="c1">;; gvfs              ;for user mounts</span>
                   <span class="nv">openssh</span>
                   <span class="nv">zsh</span>
                   <span class="nv">icecat</span>
                   <span class="nv">curl</span> <span class="nv">wget</span> <span class="nv">rsync</span>
                   <span class="nv">git</span>
                   <span class="nv">fontconfig</span> <span class="nv">xdg-user-dirs</span>
                   <span class="c1">;; mate-screensaver</span>
                   <span class="nv">ncurses</span> <span class="nv">gcc</span> <span class="nv">binutils</span> <span class="nv">file</span>
                   <span class="nv">arc-theme</span>
                   <span class="nv">network-manager-applet</span>
                   <span class="nv">ibus</span> <span class="nv">ibus-rime</span> <span class="nv">librime</span> <span class="nv">rime-data</span>
                   <span class="nv">%base-packages</span><span class="p">))</span>

  <span class="c1">;; Add GNOME and/or Xfce---we can choose at the log-in</span>
  <span class="c1">;; screen with F1.  Use the "desktop" services, which</span>
  <span class="c1">;; include the X11 log-in service, networking with</span>
  <span class="c1">;; NetworkManager, and more.</span>
  <span class="p">(</span><span class="nf">services</span> <span class="p">(</span><span class="nf">cons*</span> <span class="p">(</span><span class="nf">mate-desktop-service</span><span class="p">)</span>
                   <span class="p">(</span><span class="nf">gnome-desktop-service</span><span class="p">)</span>
                   <span class="p">(</span><span class="nf">xfce-desktop-service</span><span class="p">)</span>
                   <span class="c1">;; (plasma-desktop-service) ;; Not there yet</span>
                   <span class="p">(</span><span class="nf">service</span> <span class="nv">openssh-service-type</span>
                     <span class="p">(</span><span class="nf">openssh-configuration</span>
                       <span class="p">(</span><span class="nf">x11-forwarding?</span> <span class="no">#t</span><span class="p">)))</span>
                   <span class="nv">%desktop-services</span><span class="p">))</span>

  <span class="c1">;; Allow resolution of '.local' host names with mDNS.</span>
  <span class="p">(</span><span class="nf">name-service-switch</span> <span class="nv">%mdns-host-lookup-nss</span><span class="p">))</span>
</code></pre>
                  </div>
                </div>
                <p>然后是我的 NixOS 配置，这个我还是花了一些时间改的，参考了别人的几个配置：
                  （这个在使用的时候要注意，需要先添加 <a href="https://github.com/NixOS/nixos-hardware">nixos-hardware</a> 这个 channel，然后改成你的机型）</p>
                <div class="language-nix highlighter-rouge">
                  <div class="highlight">
                    <pre class="highlight"><code><span class="c"># Edit this configuration file to define what should be installed on</span>
<span class="c"># your system.  Help is available in the configuration.nix(5) man page</span>
<span class="c"># and in the NixOS manual (accessible by running ‘nixos-help’).</span>

<span class="p">{</span> <span class="nv">config</span><span class="p">,</span> <span class="nv">pkgs</span><span class="p">,</span> <span class="o">...</span> <span class="p">}:</span>

<span class="p">{</span>
  <span class="nv">imports</span> <span class="o">=</span>
    <span class="p">[</span> <span class="c"># Include the results of the hardware scan.</span>
      <span class="o">&lt;</span><span class="sx">nixos-hardware/lenovo/thinkpad/x220</span><span class="o">&gt;</span>
      <span class="sx">./hardware-configuration.nix</span>
    <span class="p">];</span>

  <span class="c"># Hardware configuration</span>
  <span class="nv">sound</span><span class="o">.</span><span class="nv">enable</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
  <span class="nv">hardware</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nv">enableAllFirmware</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="nv">cpu</span><span class="o">.</span><span class="nv">intel</span><span class="o">.</span><span class="nv">updateMicrocode</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="nv">trackpoint</span><span class="o">.</span><span class="nv">emulateWheel</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="nv">pulseaudio</span><span class="o">.</span><span class="nv">enable</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="nv">bluetooth</span><span class="o">.</span><span class="nv">enable</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="nv">opengl</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nv">driSupport</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="nv">driSupport32Bit</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">};</span>
  <span class="p">};</span>

  <span class="c"># Use the GRUB EFI boot loader.</span>
  <span class="nv">boot</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nv">loader</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nv">efi</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nv">canTouchEfiVariables</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="nv">efiSysMountPoint</span> <span class="o">=</span> <span class="s2">"/boot/efi"</span><span class="p">;</span>
      <span class="p">};</span>
      <span class="nv">systemd-boot</span><span class="o">.</span><span class="nv">enable</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">};</span>
    <span class="nv">kernelPackages</span> <span class="o">=</span> <span class="nv">pkgs</span><span class="o">.</span><span class="nv">linuxPackages_4_20</span><span class="p">;</span>
    <span class="nv">kernelParams</span> <span class="o">=</span> <span class="p">[</span>
      <span class="s2">"thinkpad_acpi.fan_control=1"</span>
      <span class="s2">"acpi_osi=</span><span class="se">\"</span><span class="s2">!Windows 2012</span><span class="se">\"</span><span class="s2">"</span>
      <span class="s2">"acpi_osi=Linux"</span>
      <span class="s2">"acpi=force"</span>
    <span class="p">];</span>
    <span class="nv">initrd</span><span class="o">.</span><span class="nv">kernelModules</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">"acpi"</span> <span class="s2">"thinkpad-acpi"</span> <span class="s2">"acpi-call"</span> <span class="p">];</span>
    <span class="nv">supportedFilesystems</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">"nfs"</span> <span class="s2">"ntfs"</span> <span class="s2">"exfat"</span> <span class="p">];</span>
  <span class="p">};</span>

  <span class="nv">networking</span><span class="o">.</span><span class="nv">hostName</span> <span class="o">=</span> <span class="s2">"x220"</span><span class="p">;</span> <span class="c"># Define your hostname.</span>
  <span class="nv">networking</span><span class="o">.</span><span class="nv">nameservers</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">"1.1.1.1"</span> <span class="s2">"1.0.0.1"</span> <span class="s2">"4.2.2.1"</span> <span class="s2">" 4.2.2.2"</span> <span class="s2">"9.9.9.9"</span> <span class="s2">"8.8.8.8"</span> <span class="s2">"8.8.4.4"</span> <span class="p">];</span>
  <span class="nv">networking</span><span class="o">.</span><span class="nv">networkmanager</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nv">enable</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="nv">dns</span> <span class="o">=</span> <span class="s2">"none"</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="c"># Configure network proxy if necessary</span>
  <span class="c"># networking.proxy.default = "http://user:password@proxy:port/";</span>
  <span class="c"># networking.proxy.noProxy = "127.0.0.1,localhost,internal.domain";</span>

  <span class="c"># Select internationalisation properties.</span>
  <span class="nv">i18n</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nv">consoleFont</span> <span class="o">=</span> <span class="s2">"Lat2-Terminus16"</span><span class="p">;</span>
    <span class="nv">consoleKeyMap</span> <span class="o">=</span> <span class="s2">"us"</span><span class="p">;</span>
    <span class="nv">defaultLocale</span> <span class="o">=</span> <span class="s2">"en_US.UTF-8"</span><span class="p">;</span>
    <span class="nv">inputMethod</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nv">enabled</span> <span class="o">=</span> <span class="s2">"ibus"</span><span class="p">;</span>
      <span class="nv">ibus</span><span class="o">.</span><span class="nv">engines</span> <span class="o">=</span> <span class="kn">with</span> <span class="nv">pkgs</span><span class="o">.</span><span class="nv">ibus-engines</span><span class="p">;</span> <span class="p">[</span> <span class="nv">libpinyin</span> <span class="nv">mozc</span> <span class="p">];</span>
    <span class="p">};</span>
  <span class="p">};</span>

  <span class="c"># Set your time zone.</span>
  <span class="nv">time</span><span class="o">.</span><span class="nv">timeZone</span> <span class="o">=</span> <span class="s2">"America/Los_Angeles"</span><span class="p">;</span>

  <span class="c"># List packages installed in system profile. To search, run:</span>
  <span class="c"># $ nix search wget</span>
  <span class="nv">environment</span><span class="o">.</span><span class="nv">systemPackages</span> <span class="o">=</span> <span class="kn">with</span> <span class="nv">pkgs</span><span class="p">;</span> <span class="p">[</span>
    <span class="nv">wget</span> <span class="nv">vim</span> <span class="nv">nano</span> <span class="nv">sudo</span> <span class="nv">tmux</span> <span class="nv">curl</span> <span class="nv">zsh</span> <span class="nv">networkmanagerapplet</span> <span class="nv">firefox</span>
    <span class="nv">unzip</span> <span class="nv">spotify</span> <span class="nv">w3m</span> <span class="nv">ntfs3g</span> <span class="nv">gptfdisk</span> <span class="nv">gcc</span> <span class="nv">autoconf</span> <span class="nv">bluez</span> <span class="nv">gnumake</span>
    <span class="nv">xclip</span> <span class="nv">ffmpeg</span> <span class="nv">cryptsetup</span> <span class="nv">pavucontrol</span> <span class="nv">automake</span> <span class="nv">unrar</span> <span class="nv">p7zip</span>
    <span class="nv">tdesktop</span> <span class="nv">git</span> <span class="nv">tilix</span> <span class="nv">file</span> <span class="nv">htop</span> <span class="nv">gtk-engine-murrine</span> <span class="nv">arc-theme</span>
    <span class="nv">gnome-themes-extra</span> <span class="nv">gnome-themes-standard</span> <span class="nv">papirus-icon-theme</span>
    <span class="nv">wireguard</span> <span class="nv">scrot</span> <span class="nv">neofetch</span> <span class="nv">restic</span> <span class="nv">ibus-qt</span>
  <span class="p">];</span>

  <span class="nv">nixpkgs</span><span class="o">.</span><span class="nv">config</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nv">android_sdk</span><span class="o">.</span><span class="nv">accept_license</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="nv">allowUnfree</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="c"># powerManagement.cpuFreqGovernor = pkgs.lib.mkForce null;</span>

  <span class="c"># Some programs need SUID wrappers, can be configured further or are</span>
  <span class="c"># started in user sessions.</span>
  <span class="c"># programs.mtr.enable = true;</span>
  <span class="nv">programs</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nv">light</span><span class="o">.</span><span class="nv">enable</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="nv">adb</span><span class="o">.</span><span class="nv">enable</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="nv">java</span><span class="o">.</span><span class="nv">enable</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="nv">gnupg</span><span class="o">.</span><span class="nv">agent</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nv">enable</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span> 
      <span class="nv">enableSSHSupport</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">};</span>
    <span class="nv">zsh</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nv">enable</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="nv">ohMyZsh</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nv">enable</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="nv">plugins</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">"git"</span> <span class="s2">"python"</span> <span class="s2">"man"</span> <span class="p">];</span>
        <span class="nv">theme</span> <span class="o">=</span> <span class="s2">"robbyrussell"</span><span class="p">;</span>
      <span class="p">};</span>
    <span class="p">};</span>
  <span class="p">};</span>

  <span class="c"># List services that you want to enable:</span>

  <span class="c"># Power related</span>
  <span class="nv">services</span><span class="o">.</span><span class="nv">tlp</span><span class="o">.</span><span class="nv">enable</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
  <span class="nv">services</span><span class="o">.</span><span class="nv">thermald</span><span class="o">.</span><span class="nv">enable</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

  <span class="c"># Redshift</span>
  <span class="nv">services</span><span class="o">.</span><span class="nv">redshift</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nv">enable</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="nv">latitude</span> <span class="o">=</span> <span class="s2">"36.7"</span><span class="p">;</span>
    <span class="nv">longitude</span> <span class="o">=</span> <span class="s2">"119.8"</span><span class="p">;</span>
    <span class="nv">temperature</span><span class="o">.</span><span class="nv">day</span> <span class="o">=</span> <span class="mi">5700</span><span class="p">;</span>
    <span class="nv">temperature</span><span class="o">.</span><span class="nv">night</span> <span class="o">=</span> <span class="mi">3500</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="c"># Enable the OpenSSH daemon.</span>
  <span class="nv">services</span><span class="o">.</span><span class="nv">openssh</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nv">enable</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="nv">startWhenNeeded</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="nv">forwardX11</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="nv">allowSFTP</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="nv">permitRootLogin</span> <span class="o">=</span> <span class="s2">"no"</span><span class="p">;</span>
    <span class="nv">openFirewall</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="nv">passwordAuthentication</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="nv">challengeResponseAuthentication</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="c"># Firewall.</span>
  <span class="nv">networking</span><span class="o">.</span><span class="nv">firewall</span><span class="o">.</span><span class="nv">allowedTCPPorts</span> <span class="o">=</span> <span class="p">[</span> <span class="mi">22</span> <span class="p">];</span>
  <span class="c"># networking.firewall.allowedUDPPorts = [ ... ];</span>
  <span class="c"># Or disable the firewall altogether.</span>
  <span class="c"># networking.firewall.enable = false;</span>

  <span class="c"># Enable CUPS to print documents.</span>
  <span class="nv">services</span><span class="o">.</span><span class="nv">printing</span><span class="o">.</span><span class="nv">enable</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

  <span class="c"># Enable the X11 windowing system.</span>
  <span class="nv">services</span><span class="o">.</span><span class="nv">xserver</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nv">enable</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="nv">layout</span> <span class="o">=</span> <span class="s2">"us"</span><span class="p">;</span>
    <span class="nv">xkbOptions</span> <span class="o">=</span> <span class="s2">"terminate:ctrl_alt_bksp"</span><span class="p">;</span>
    <span class="nv">videoDrivers</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">"modesetting"</span> <span class="p">];</span>
    <span class="nv">displayManager</span><span class="o">.</span><span class="nv">lightdm</span><span class="o">.</span><span class="nv">enable</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="nv">desktopManager</span><span class="o">.</span><span class="nv">mate</span><span class="o">.</span><span class="nv">enable</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="nv">libinput</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nv">enable</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="nv">disableWhileTyping</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="nv">tapping</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">};</span>
  <span class="p">};</span>

  <span class="c"># Enable flatpak</span>
  <span class="nv">services</span><span class="o">.</span><span class="nv">flatpak</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nv">enable</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="nv">extraPortals</span> <span class="o">=</span> <span class="p">[</span> <span class="nv">pkgs</span><span class="o">.</span><span class="nv">xdg-desktop-portal-gtk</span> <span class="p">];</span>
  <span class="p">};</span>

  <span class="c"># Define a user account. Don't forget to set a password with ‘passwd’.</span>
  <span class="nv">users</span><span class="o">.</span><span class="nv">users</span><span class="o">.</span><span class="nv">kay</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nv">isNormalUser</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="nv">uid</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
    <span class="nv">home</span> <span class="o">=</span> <span class="s2">"/home/kay"</span><span class="p">;</span>
    <span class="nv">description</span> <span class="o">=</span> <span class="s2">"Kay"</span><span class="p">;</span>
    <span class="nv">shell</span> <span class="o">=</span> <span class="nv">pkgs</span><span class="o">.</span><span class="nv">zsh</span><span class="p">;</span>
    <span class="nv">extraGroups</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">"wheel"</span> <span class="s2">"audio"</span> <span class="s2">"video"</span> <span class="s2">"disk"</span> <span class="s2">"cdrom"</span> <span class="s2">"users"</span> <span class="s2">"systemd-journal"</span> <span class="s2">"lp"</span> <span class="s2">"networkmanager"</span> <span class="p">];</span>
    <span class="nv">openssh</span><span class="o">.</span><span class="nv">authorizedKeys</span><span class="o">.</span><span class="nv">keys</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">"ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIDWeay/xBNMhnBy3GJcGkQNNa44gRBqXYa+F4RW6VW1E kay@bazinga"</span> <span class="p">];</span>
  <span class="p">};</span>

  <span class="nv">security</span><span class="o">.</span><span class="nv">sudo</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nv">enable</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="nv">wheelNeedsPassword</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="c"># This value determines the NixOS release with which your system is to be</span>
  <span class="c"># compatible, in order to avoid breaking some software such as database</span>
  <span class="c"># servers. You should change this only after NixOS release notes say you</span>
  <span class="c"># should.</span>
  <span class="nv">system</span><span class="o">.</span><span class="nv">stateVersion</span> <span class="o">=</span> <span class="s2">"18.09"</span><span class="p">;</span> <span class="c"># Did you read the comment?</span>

<span class="p">}</span>
</code></pre>
                  </div>
                </div>
                <p>我就放在 <a href="https://v2bv.net/configuration.nix">https://v2bv.net/configuration.nix</a> 好叻！</p>
                <hr />
                <p>说起来还有个 Fedora SilverBlue 看起来也挺有意思，什么时候去试试看（</p>
                <div id="disqus_thread"></div>
                <script>
                  var disqus_config = function () {
                    this.page.url = "https://v2bv.net/2019/guixsd-and-nixos";
                    this.page.identifier = "/2019/guixsd-and-nixos";
                  };
                  (function() {
                    var d = document, s = d.createElement('script');
                    s.src = '//sth-1.disqus.com/embed.js';
                    s.setAttribute('data-timestamp', +new Date());
                    (d.head || d.body).appendChild(s);
                  })();
                </script>
                <noscript>
                  Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
                </noscript>
              </div>
              <footer class="c-article__footer">
                <p>
                </p>
              </footer>
            </article>
            <div id="disqus_thread"></div>
            <script>
              var disqus_config = function () {
                this.page.url = "https://v2bv.net/2019/guixsd-and-nixos";
                this.page.identifier = "/2019/guixsd-and-nixos";
              };
              (function() {
                var d = document, s = d.createElement('script');
                s.src = '//sth-1.disqus.com/embed.js';
                s.setAttribute('data-timestamp', +new Date());
                (d.head || d.body).appendChild(s);
              })();
            </script>
            <noscript>
              Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
            </noscript>
          </div>
          <footer class="c-page__footer" id="page_footer">
          </hr>
          <p>
            <script type='text/javascript'>
              fortune = new Array(9);
              fortune[0] = 'You Door All Dalao Except Me I good vegetable ah...';
              fortune[1] = 'すべてはシュタインズ・ゲートの選択である!';
              fortune[2] = 'Pen Pineapple Apple Pen ~';
              fortune[3] = 'なんでそんなに慣れてんだよっ！';
              fortune[4] = 'あたしが、先だった……先だったんだ……';
              fortune[5] = '+1s +1s +1s +1s +1s +1s +1s +1s';
              fortune[6] = 'どうしてこうなるんだろう…';
              fortune[7] = '你也配姓趙？你怎麼會姓趙！——你那裡配姓趙！';
              fortune[8] = '你才是法師！你全家都是法師！';
              index = Math.floor(Math.random() * fortune.length);
              document.write(fortune[index]);
            </script>
            <noscript>どうしてこうなるんだろう…</noscript>
          </p>
        </hr>
      </br>
      <p>
        &copy; KayMW 
        2020 | Powered by Jekyll | Using theme: Biu
      </p>
    </br>
    <p>Follow me on: 
      <a rel="me" href="https://s.brined.fish/@KayMW">Mastodon</a>
      &
      <a href="https://github.com/RedL0tus">Github</a>
      <span class="u-separate"></span>
      Subscribe: <a href="/feed.xml">RSS</a>
    </p>
  </footer>
</article>
</div>
</div>
</body>
</html>